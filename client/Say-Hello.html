<head>
  <title>Say Hello Web-App</title>
  
	<script src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
	
    <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css">
        <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
<!--
	<script>
		var init_stuff;
		function initialize() {
			init_stuff = window.setInterval(function() {
			window.clearInterval(init_stuff);
			var map_canvas = document.getElementById("map_canvas");
			var map_options = {
				center: new google.maps.LatLng(40.4319, -86.9202),
				zoom: 16,
				scrollwheel: false,
				disableDoubleClickZoom: true,
				streetViewControl: false
			}
			var map = new google.maps.Map(map_canvas, map_options);
			//google.maps.event.addListener(map, 'idle', function() {
				// generate markers
			//	alert("Google Map Loaded.");
				/*
				for (var _event in CurrentEvents.find().fetch()) {
					console.log("Event: " + _event[0]);
					var marker = getMarker(_event.x, _event.y);
					marker.setMap(map);
				}
				*/
				CurrentEvents.find().forEach(function(_event) {
					console.log("Event: " + _event.name);
					var marker = getMarker(_event.x, _event.y);
					marker.setMap(map);
				});
			//});
			google.maps.event.addListener(map, 'dblclick', function(mouse) {
				console.log("Lat: " + mouse.latLng.lat() + 
						"\nLong: " + mouse.latLng.lng());
				if (! Meteor.userId)
					return; // not logged in
				var coords = mouse.latLng
				openCreateDialog(coords.lat(), coords.lng());
			});
			}, 100);
		}
		var openCreateDialog = function(x, y) {
			Session.set("createCoords", {x: x, y: y});
			Session.set("createError", null);
			Session.set("showCreateDialog", true);
			//initialize();
		};

		function getMarker(x, y) {
			return new google.maps.Marker({
				position: new google.maps.LatLng(x, y)
			});
		}
		google.maps.event.addDomListener(window, 'load', initialize);
		var createDia = false;
		Deps.autorun(function(c) {
			var boo = Session.get("showCreateDialog");
			if (createDia == true && boo != createDia) {
				createDia = boo;
				initialize();
			} else {
				createDia = boo;
			}
			c.stop();
		});
	</script>
-->
</head>

<body>
    <div data-role="page" id="foo">

      	<div data-role="header">
      		<h1>Say Hello</h1>
      	</div><!-- /header -->
		
  		<div data-role="content">	
  		  		{{> page}}
  		  	</div><!-- /content -->

      	<div data-role="footer">
      		{{> footer}}
      	</div><!-- /footer -->
      </div><!-- /page -->
</body>

<template name="page">
	{{#isolate}}
  {{#if showCreateDialog}}
    {{> createDialog}}
  {{/if}}
	{{/isolate}}

  <div class="container">
    <div class="row">
      <div class="span1"> </div>

      <div class="span10">
        <div class="header row">
          <div class="span5">
            <div style="float: right">
							{{#isolate}}
              {{loginButtons align="right"}}
							{{/isolate}}
            </div>
          </div>
        </div>
        <div class="row">
          <div class="span6">
            {{> map}}
            <script>
		initialize();
            </script>
						{{#isolate}}
            {{#if currentUser}}
            <div class="pagination-centered">
              <em><small>Double click the map to post an event!</small></em><br />
							{{#if canGeolocate}}
							<p>Alternatively, click <a href="#" target="_blank" class="curLoc">here</a> to create an event where you are.</p>
							{{/if}}
            </div>
            {{/if}}
						{{/isolate}}
          </div>
          <div class="span4">
						{{#isolate}}
            {{> details}}
						{{/isolate}}
          </div>
        </div>
      </div>

      <div class="span1"> </div>
    </div>
  </div>
</template>

<template name="map">
  <div class="map" id="map_canvas" load="initialize();">
    {{#constant}}
      <svg width="500" height="500">
        <circle class="callout" cx=-100 cy=-100></circle>
				<g class="circles"></g>
				<g class="labels"></g>
			</svg>
		{{/constant}}
		<div>
			<small class="attribution muted">&copy;
				<a href="http://maps.google.com" 
								target="_blank">Google</a>
			</small>
		</div>
</template>

<template name="details">
	<div class="details">
	{{#if _event}}
		{{#with _event}}
			<h1>{{name}}</h1>
			<div class="description">{{description}}</div>

			{{#if currentUser}}
				{{#if attending}}
					{{#if signedIn _event currentUser}}
						{{> attendance}}
					{{/if}}
				{{/if}}
			{{/if}}

			<div class="sign_in-out_buttons">
				{{#if currentUser}}
					{{#if signedIn _event currentUser}}
						<input type="button" value="Sign Out" class="sign btn sign-out"/>
					{{else}}
						<input type="button" value="Sign In" class="sign btn sign-in" />
					{{/if}}
					<p><small>Posted by {{creatorName}}</small></p>
				{{else}}
					<i>Log in to sign into this event.</i><br />
					<i>Signing in to an event allows you to see who all is there.</i>
				{{/if}}
			</div>

			{{#if canClose}}
				<--! TODO: add a close event button -->
			{{/if}}
		{{/with}}
	{{else}}
		<h1 class="muted pagination-centered">
			{{#if anyEvents}}
				Click a party to select it or log in to create your own event!
			{{else}}
				Log in and double click the map to post an event.
			{{/if}}
		</h1>
	{{/if}}
	</div>
</template>

<template name="attendance">
	<div class="attendance well well-small">
		<div class="muted who"><b>Who Is Here:</b></div>
		
		{{#each attendees}}
			<div>
				{{name}}
			</div>
		{{/each}}

	</div>
</template>

<template name="createDialog">
	<div class="mask"> </div>
	<div class="modal">
		<div class="modal-header">
			<button type="button" class="close cancel">&times;</button>
			<h3>Add Event</h3>
		</div>

		<div class="modal-body">
			{{#if error}}
				<div class="alert alert-error">{{error}}</div>
			{{/if}}

			<label>Name</label>
			<input type="text" class="name span5" />

			<label>Description</label>
			<textarea class="description span5"></textarea>
		</div>
		<div class="modal-footer">
			<a href="#" class="btn cancel">Cancel</a>
			<a href="#" class="btn btn-primary save">Add Event</a>
		</div>
	</div>
</template>

<template name="footer">
	<h5>Lets try putting the mavigation here, at least for DEMO 1</h5>
</template>
